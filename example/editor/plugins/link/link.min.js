!function(){"use strict";var r,t=e=>t=>((t=void 0)=>{var e=typeof t;switch(!0){case null===t:return"null";case"object"==e&&Array.isArray(t):return"array";default:return e}})(t)===e;const e=t("array"),N=t("string"),i=t("function"),U=t=>e(t)&&0===t.length,v=(e,r)=>{const n=e.length;for(let t=0;t<n;++t)r(e[t],()=>{t=n})},d=(t,...e)=>t.push(...e),n=(t,e)=>{return null==(t=Object.assign(null!=t?t:{}))?void 0:t[e]},a=(...t)=>{return[t,...e]=["",...t],e.join(t);var e},l=/^((?:https?|ftp):\/\/|mailto:)?([\da-z.-]+)\.([a-z.]{2,6})([/\w.-]*)*\/?$/i,o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,s=/^(https?|ftp|mailto):/,g=t=>{var e;return e=t,l.test(e)?(e=t,s.test(e)?t:a("https://",t)):(e=t,o.test(e)?a("mailto:",t):t)};(t=r=r||{})[t.UNKNOWN=0]="UNKNOWN",t[t.ELEMENT=1]="ELEMENT",t[t.ATTRIBUTE=2]="ATTRIBUTE",t[t.TEXT=3]="TEXT",t[t.CDATA_SECTION=4]="CDATA_SECTION",t[t.ENTITY_REFERENCE=5]="ENTITY_REFERENCE",t[t.ENTITY=6]="ENTITY",t[t.PROCESSING_INSTRUCTION=7]="PROCESSING_INSTRUCTION",t[t.COMMENT=8]="COMMENT",t[t.DOCUMENT=9]="DOCUMENT",t[t.DOCUMENT_TYPE=10]="DOCUMENT_TYPE",t[t.DOCUMENT_FRAGMENT=11]="DOCUMENT_FRAGMENT",t[t.NOTATION=12]="NOTATION";t=e=>t=>{return t=t,(null!=(t=n(t,"nodeType"))?t:r.UNKNOWN)===e};t(r.ELEMENT),t(r.ATTRIBUTE);const F=t(r.TEXT),T=(t(r.CDATA_SECTION),t(r.ENTITY_REFERENCE),t(r.ENTITY),t(r.PROCESSING_INSTRUCTION),t(r.COMMENT),t(r.DOCUMENT),t(r.DOCUMENT_TYPE),t(r.DOCUMENT_FRAGMENT),t(r.NOTATION),n=>{const g=n,T=g.DOM,r=g.Formatter.Formats,a=g.Formatter.Utils;return{ClosestBlock:t=>{var e;return null!=(e=T.Closest(a.GetParentIfText(t),{tagName:(e=r.BlockFormatTags.Block,Array.from(e))}))?e:T.Closest(a.GetParentIfText(t),r.ListItemSelector)},UnwrapAnchor:t=>v(n.DOM.SelectAll("a",t),t=>{var e=n.DOM.CreateFragment(),r=t.parentNode;n.DOM.Insert(e,...n.DOM.GetChildNodes(t)),null!=r&&r.replaceChild(e,t)}),TrimTextsRangeEdge:(t,e,r=!1)=>{var n=t.textContent;return n&&a.SplitTextNode(g,t,r?e:0,r?n.length:e)||t},FindSibling:(t,e)=>{let r=t;for(;r;){var n=e?r.previousSibling:r.nextSibling;if(n){r=n;break}r=r.parentNode}return F(r)||T.Utils.IsBr(r)?r:(e?T.Utils.GetLastChild:T.Utils.GetFirstChild)(r,!0)},PutNodesIntoFragment:(t,e,r)=>{var n,a=T.CreateFragment();let l=null,o=t.parentNode,s=t;for(var i=r?T.InsertFirst:T.Insert,d=r?T.Insert:T.InsertFirst;o&&o!==g.GetBody();){var u=T.Clone(o);for(o===e&&(l=null!=(n=r?null===s||void 0===s?void 0:s.nextSibling:null===s||void 0===s?void 0:s.previousSibling)?n:null);s;){var N=r?s.previousSibling:s.nextSibling;i(u,s),s=N}if(T.Utils.HasChildNodes(a)&&d(u,...T.GetChildNodes(a)),o===e){T.Insert(a,...T.GetChildNodes(u));break}T.Insert(a,u),s=r?o.previousSibling:o.nextSibling,o=o.parentNode}return[a,l]},ToggleAllInLine:(t,e,r,n,a)=>{let l=t;for(;l;){var o=l.parentNode,s=r?l.nextSibling:l.previousSibling;if(s){if(i(a)&&a(s))break;n(s),l=s}else{if(o===e)break;l=o}}}}}),C=(t,u)=>{const N=t,g=N.DOM,o=N.Formatter.Utils,T=N.Utils.Caret,C=N.Utils.Range,I=t=>{t=o.GetParentIfText(t),t=g.SelectAll("a",t);v(t,t=>{var e,r=g.CreateFragment();g.Insert(r,...g.GetChildNodes(t)),null!=(e=t.parentNode)&&e.replaceChild(r,t)})},s=(t,e,r)=>{var n=[null,null,null],a=u.FindSibling(t,!0),l=u.FindSibling(e,!1),a=(a&&(n[0]=u.PutNodesIntoFragment(a,r,!0)[0]),l&&d(n,u.PutNodesIntoFragment(l,r,!1)[0]),u.PutNodesIntoFragment(t,r,!0)[0]);u.UnwrapAnchor(a),n[1]=a,t!==e&&(l=u.PutNodesIntoFragment(e,r,!0)[0],u.UnwrapAnchor(l),n[2]=l),g.Insert(r,...n)},E=(t,e,r)=>{s(t,e,r);r=C();return r.SetStart(t,0),r.SetEnd(e,null!=(e=null==(t=e.textContent)?void 0:t.length)?e:0),T.UpdateRange(r),!0},f=(t,e,r)=>{var[t,n]=u.PutNodesIntoFragment(t,e,!r),a=(u.UnwrapAnchor(t),r?g.Insert:g.InsertFirst),r=r?g.InsertAfter:g.InsertBefore;(n?r:a)(null!=n?n:e,t)};return{UnwrapFromCaret:()=>{const e=T.Get();var t,r,n,a,l;if(e)return t=()=>{var t;o.CleanDirtyWithCaret(N,null!=(t=T.Get())?t:e),N.Focus()},(t=>{if(t.IsRange())return!1;const r=g.Closest(o.GetParentIfText(t.Start.Node),"a");return!!r&&(o.RunFormatting(N,()=>{var t,e=g.CreateFragment();g.Insert(e,...g.GetChildNodes(r)),null!=(t=r.parentNode)&&t.replaceChild(e,r)}),!0)})(e)||((r=e).IsRange()&&r.Start.Node===r.End.Node&&(n=r.Start.Node,n=o.SplitTextNode(N,n,r.Start.Offset,r.End.Offset),F(n))&&(r=C(),a=g.Closest(o.GetParentIfText(n),"a"),l=u.ClosestBlock(n),a)&&l?(s(n,n,l),r.SetStartToEnd(n,0,n.length),T.UpdateRange(r),1):(e=>{if(!e.IsRange())return!1;var r=u.TrimTextsRangeEdge(e.Start.Node,e.Start.Offset,!0),n=u.TrimTextsRangeEdge(e.End.Node,e.End.Offset),a=(e.Range.SetStart(r,r===e.Start.Node?e.Start.Offset:0),e.Range.SetEnd(n,null!=(a=null==(a=n.textContent)?void 0:a.length)?a:0),u.ClosestBlock(r)),l=u.ClosestBlock(n);if(!a||!l)return!1;if(a===l)E(r,n,a);else{f(r,a,!0);let t=a;for(;t;){var o=t.parentNode,s=t.nextSibling;if(s){if(g.Utils.IsChildOf(l,s))break;I(s),t=s}else{if(o===N.GetBody())break;t=o}}for(t=l;t;){var i=t.parentNode,d=t.previousSibling;if(d)I(d),t=d;else{if(i===e.End.Path[0])break;t=i}}f(n,l,!1);a=C();a.SetStart(r,r===e.Start.Node?e.Start.Offset:0),a.SetEnd(n,null!=(n=null==(r=n.textContent)?void 0:r.length)?n:0),T.UpdateRange(a)}return!0})(e))?t():void 0}}},I=(t,N)=>{const g=t,T=g.DOM,a=g.Formatter.Formats,C=g.Formatter.Utils,I=g.Utils.Caret,E=g.Utils.Range,f=(t,e)=>{t=T.Create("a",{attrs:{href:t},children:[null!=e?e:null]});return T.SetAttr(t,"href",t.href),t},S=()=>{var e,r=T.SelectAll("a",g.GetBody());{var n=r,a=t=>{var e=t.previousElementSibling;T.Utils.IsAnchor(e)&&e.href===t.href&&(T.Insert(e,...T.GetChildNodes(t)),T.Remove(t))};let t=!1;for(var l=()=>{t=!0};!(U(n)||(e=n.shift())&&(a(e,l),t)););}},c=(t,e)=>{var r=T.Utils.GetNodeName(t);if(!a.AllDisableList.has(r)){if(a.AllBlockFormats.has(r)&&!a.BlockFormatTags.Block.has(r))return v(T.GetChildNodes(t),t=>c(t,e));if(!a.BlockFormatTags.Block.has(r)){const n=f(e);return T.CloneAndInsert(n,!0,t),N.UnwrapAnchor(n),null==(r=t.parentElement)?void 0:r.replaceChild(n,t)}r=T.GetChildNodes(t);if(!(U(r)||1===r.length&&T.Utils.IsBr(r[0]))){const n=f(e);T.Insert(n,...r),N.UnwrapAnchor(n),T.Insert(t,n)}}},m=(t,e,r,n)=>{var a=[null,null,null],l=N.FindSibling(t,!0),o=N.FindSibling(e,!1),l=(l&&(a[0]=N.PutNodesIntoFragment(l,r,!0)[0]),o&&d(a,N.PutNodesIntoFragment(o,r,!1)[0]),f(n,N.PutNodesIntoFragment(t,r,!0)[0]));N.UnwrapAnchor(l),a[1]=l,t!==e&&(o=f(n,N.PutNodesIntoFragment(e,r,!0)[0]),N.UnwrapAnchor(o),a[2]=o),T.Insert(r,...a)},h=(t,e,r,n,a,l)=>{m(t,e,a,l);a=E();return a.SetStart(t,r),a.SetEnd(e,n),I.UpdateRange(a),!0},p=(t,e,r,n)=>{var[t,a]=N.PutNodesIntoFragment(t,e,!n),r=f(r,t),t=(N.UnwrapAnchor(r),n?T.Insert:T.InsertFirst),n=n?T.InsertAfter:T.InsertBefore;(a?n:t)(null!=a?a:e,r)};return{WrapFromCaret:t=>{if(e=t,r=T.Element.Table.GetSelectedCells(g),U(r)||(v(r,t=>c(t,e)),0)){var e,r,n,a,l,o,s,i,d;const u=I.Get();if(u)return r=()=>{var t;C.DoWithShallowMarking(g,null!=(t=I.Get())?t:u,S),C.CleanDirtyWithCaret(g,null!=(t=I.Get())?t:u),g.Focus()},n=u,a=t,(n.IsRange()?(l=u,o=t,l.IsRange()&&l.Start.Node===l.End.Node&&(s=l.Start.Node,s=C.SplitTextNode(g,s,l.Start.Offset,l.End.Offset),F(s))?(l=E(),i=T.Closest(C.GetParentIfText(s),"a"),d=N.ClosestBlock(s),i&&d?(m(s,s,d,o),l.SetStartToEnd(s,0,s.length)):(i=T.Clone(s),d=f(o,i),null!=(o=s.parentNode)&&o.replaceChild(d,s),l.SetStartToEnd(i,0,s.length)),I.UpdateRange(l),1):((e,r)=>{if(!e.IsRange())return!1;var t=N.TrimTextsRangeEdge(e.Start.Node,e.Start.Offset,!0),n=N.TrimTextsRangeEdge(e.End.Node,e.End.Offset),a=t===e.Start.Node?e.Start.Offset:0,l=n===e.End.Node?e.End.Offset:null!=(l=null==(l=n.textContent)?void 0:l.length)?l:0,o=(e.Range.SetStart(t,a),e.Range.SetEnd(n,l),N.ClosestBlock(t));const s=N.ClosestBlock(n);return!(!o||!s||(o===s?h(t,n,a,l,o,r):(p(t,o,r,!0),N.ToggleAllInLine(o,g.GetBody(),!0,t=>c(t,r),t=>T.Utils.IsChildOf(s,t)),N.ToggleAllInLine(s,e.End.Path[0],!1,t=>c(t,r),t=>!T.Utils.IsChildOf(e.End.Path[0],t)),p(n,s,r,!1),(o=E()).SetStart(t,a),o.SetEnd(n,l),I.UpdateRange(o)),0))})(u,t)):((o=null!=(o=T.Closest(C.GetParentIfText(n.Start.Node),"a"))?o:T.Closest(C.GetParentIfText(n.End.Node),"a"))?(T.GetHTML(o)===T.GetAttr(o,"href")&&T.SetText(o,a),T.SetAttr(o,"href",a),T.SetAttr(o,"href",o.href)):(o=f(a,T.CreateTextNode(a)),n.Range.Insert(o),(n=E()).SetStartToEnd(T.Utils.GetFirstChild(o),a.length,a.length),I.UpdateRange(n)),1))?r():void 0}}}},u=t=>{const a=t,l=a.DOM,o=a.Utils.Caret,s=a.Formatter,r=s.Formats;t=s.Detector;const i="Link",d={Title:a.Lang("plugins.link.title","Insert/Edit a link"),CommandName:"Hyperlink",Icon:"Hyperlink"},u=s.UI.CreateIconButton(d.Title,d.Icon);s.UI.RegisterCommand(a,d.CommandName,(t,e)=>{s.UI.IsDisabled(u)||((t=>{var e=T(t);const r=I(t,e),n=C(t,e);return{ToggleFromCaret:(t,e)=>{if(!t)return n.UnwrapFromCaret();N(e)&&(t=g(e),r.WrapFromCaret(t))}}})(a).ToggleFromCaret(t,e),s.UI.ToggleActivateClass(u,t))}),s.UI.BindOptionListEvent(a,{type:i,activable:u,clickable:u,create:()=>{var t=o.Get(),e=t?null!=(e=l.Closest(s.Utils.GetParentIfText(t.Start.Node),"a"))?e:l.Closest(s.Utils.GetParentIfText(t.End.Node),"a"):null,t=l.Utils.IsAnchor(e),r=a.Lang("plugins.link.update","Update the link"),n=a.Lang("plugins.link.insert","Insert a link"),{OptionWrapper:e,Input:t}=s.UI.CreateInputWrapWithOptionList(a,{uiName:i,bUpdatable:t,createCallback:t=>s.UI.RunCommand(a,d.CommandName,!0,null==t?void 0:t.value),removeCallback:()=>s.UI.RunCommand(a,d.CommandName,!1),src:t?e.href:void 0,texts:{placeholder:t?r:n,cancel:a.Lang("cancel","Cancel"),insert:a.Lang("insert","Insert"),update:a.Lang("update","Update"),remove:a.Lang("remove","Remove")}});return l.Insert(a.Frame.Root,e),s.UI.SetOptionListCoordinate(a,i,u,e),t.focus(),e}}),t.Register(t=>{s.UI.ToggleActivateClass(u,(r=>{for(let t=0,e=r.length;t<e;++t){var n=r[t];if(l.Closest(n,"a"))return!0}return!1})(t));var{Figure:t,FigureElement:e}=l.Element.Figure.Find(t[0]),t=!!t&&!!e&&r.AllDisableList.has(l.Utils.GetNodeName(e));s.UI.ToggleDisable(u,t)}),a.Toolbar.Add(i,u)};RichEditor.Loaders.Plugin.Add("link",t=>{{const e=t,r=e.Plugin,n=e.Formatter.Utils,a=["Link"],l=t=>{n.HasFormatName(t,a)&&n.GetFormatName(t,a)===a[0]&&u(e)};v(a,t=>r.Add(t,l))}})}();